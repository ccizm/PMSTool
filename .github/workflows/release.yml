name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬

on:
  release:
    types: [ published ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    name: æ„å»ºå¹¶ä¸Šä¼ å‘å¸ƒäº§ç‰©
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      # æ­¥éª¤2: è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # æ­¥éª¤3: å®‰è£…é¡¹ç›®ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: npm ci

      # æ­¥éª¤4: è¿è¡Œæ„å»ºè„šæœ¬ (ä½¿ç”¨ build-no-zip)
      - name: è¿è¡Œæ„å»ºè„šæœ¬
        run: npm run build-no-zip

      # æ­¥éª¤5: éªŒè¯æ„å»ºç»“æœ
      - name: éªŒè¯æ„å»ºè¾“å‡º
        run: |
          echo "æ„å»ºå®Œæˆï¼Œå½“å‰å·¥ä½œç›®å½•: $(pwd)"
          
          # æ£€æŸ¥ dist ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "dist" ]; then
            echo "é”™è¯¯: dist ç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥ï¼"
            exit 1
          fi
          
          echo "dist ç›®å½•å†…å®¹ï¼š"
          ls -la dist/
          echo "dist ç›®å½•æ–‡ä»¶æ•°é‡: $(ls -la dist/ | wc -l) ä¸ª"

      # æ­¥éª¤6: æ‰‹åŠ¨æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          # å®šä¹‰æ‰“åŒ…æ–‡ä»¶åï¼Œä½¿ç”¨æ ‡ç­¾åä½œä¸ºç‰ˆæœ¬æ ‡è¯†
          PACKAGE_NAME="hpms-tool-${{ github.ref_name }}.zip"
          echo "å‡†å¤‡æ‰“åŒ…æ–‡ä»¶: $PACKAGE_NAME"
          
          # è¿›å…¥ dist ç›®å½•å¹¶æ‰“åŒ…æ‰€æœ‰å†…å®¹
          cd dist
          zip -r "../$PACKAGE_NAME" ./*
          cd ..
          
          # éªŒè¯æ‰“åŒ…ç»“æœ
          if [ -f "$PACKAGE_NAME" ]; then
            echo "æ‰“åŒ…æˆåŠŸï¼æ–‡ä»¶å¤§å°: $(du -h "$PACKAGE_NAME" | cut -f1)"
            ls -la "$PACKAGE_NAME"
          else
            echo "é”™è¯¯: æ‰“åŒ…å¤±è´¥ï¼Œæ–‡ä»¶ $PACKAGE_NAME ä¸å­˜åœ¨ï¼"
            exit 1
          fi

      # æ­¥éª¤7: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° GitHub Release
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "hpms-tool-${{ github.ref_name }}.zip"
          file_glob: false  # ä¸ä½¿ç”¨é€šé…ç¬¦ï¼Œç›´æ¥æŒ‡å®šæ–‡ä»¶å
          tag: ${{ github.ref }}
          overwrite: true
          asset_name: "hpms-tool-${{ github.ref_name }}.zip"
          asset_content_type: "application/zip"

  # å¯é€‰çš„é€šçŸ¥ä½œä¸š
  notify:
    runs-on: ubuntu-latest
    name: å‘é€æ„å»ºå®Œæˆé€šçŸ¥
    needs: build-and-release
    steps:
      - name: é€šçŸ¥æ„å»ºå®Œæˆ
        run: |
          echo "âœ… Chrome æ‰©å±•å·²æˆåŠŸæ„å»ºå¹¶ä¸Šä¼ åˆ° Release"
          echo "ğŸ“ å‘å¸ƒç‰ˆæœ¬: ${{ github.event.release.name || 'æœªå‘½åç‰ˆæœ¬' }}"
          echo "ğŸ”– å‘å¸ƒæ ‡ç­¾: ${{ github.ref_name }}"
          echo "ğŸ“… å‘å¸ƒæ—¶é—´: $(date)"
          echo "ğŸ’¡ æç¤º: æ„å»ºäº§ç‰©å·²ä¸Šä¼ è‡³ Release çš„ Assets éƒ¨åˆ†"
