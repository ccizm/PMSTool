name: 构建并发布版本

# 触发条件：当创建新的GitHub Release时执行
on:
  release:
    types: [published]

jobs:
  build-and-release:
    runs-on: ubuntu-latest  # 使用最新的Ubuntu系统

    steps:
      # 1. 拉取代码仓库
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置Node.js环境
      - name: 配置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x  # 使用Node.js 20版本，可根据需要调整
          cache: 'npm'        # 缓存npm依赖以加快构建速度

      # 3. 安装依赖
      - name: 安装依赖
        run: npm ci  # 使用ci命令安装package-lock.json中锁定的依赖版本

      # 4. 执行编译构建
      - name: 编译构建项目
        run: npm run build-no-zip  # 执行指定的构建命令

      # 5. 打包dist目录为zip文件（方便作为资产上传）
      - name: 打包构建结果
        run: |
          zip -r ${{ github.event.repository.name }}-$VERSION.zip dist

      # 6. 将打包好的文件上传到Release
      - name: 上传Release资产
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ github.event.repository.name }}-${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub自动提供的令牌
