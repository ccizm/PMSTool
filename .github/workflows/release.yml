name: Create Release

on:
  release:
    types: [ published ]

jobs:
  build-and-release:
    name: 构建并上传发布产物
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 安装依赖
        run: npm ci

      - name: 构建项目
        run: npm run build-no-zip

      - name: 生成发布说明
        id: generate-release-notes
        run: |
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1))
          echo "Previous tag: $PREVIOUS_TAG"
          
          RELEASE_NOTES=$(git log $PREVIOUS_TAG..${{ github.ref_name }} --pretty=format:"- %s (%h)" --reverse)
          
          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="No significant changes since previous release."
          fi
          
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 准备构建产物
        run: |
          mkdir -p release-artifacts
          cp -r dist/* release-artifacts/
          zip -r release.zip release-artifacts/

      - name: 创建GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## Changes in ${{ github.ref_name }}
            
            ${{ env.RELEASE_NOTES }}
            
            ### Installation
            Download the attached artifacts for your platform.
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            release.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
